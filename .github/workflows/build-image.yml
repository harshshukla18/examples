name: Build Container Image

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Check commit message
        id: commit_check
        run: |
          if [[ ${{ github.event_name }} == 'pull_request' ]]; then
            echo "Commit message check not required for pull requests."
          else
            if [[ ${{ github.event.commits.*.message }} == *"BUILD_CONTAINER_IMAGE"* ]]; then
              echo "Commit message contains BUILD_CONTAINER_IMAGE."
              echo "::set-output name=build_trigger::true"
            else
              echo "Commit message does not contain BUILD_CONTAINER_IMAGE."
              echo "::set-output name=build_trigger::false"
            fi
          fi

      - name: Set up Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo usermod -aG docker $USER
          sudo systemctl restart docker

      - name: Build and push Docker image
        if: ${{ steps.commit_check.outputs.build_trigger == 'true' || github.event_name == 'pull_request' }}
        run: |
          docker build -t your-username/guestbook-go:${{ github.sha }} guestbook-go
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
          docker push your-username/guestbook-go:${{ github.sha }}

  protect_main:
    runs-on: ubuntu-latest
    steps:
      - name: Protect main branch
        uses: actions/github-script@v5
        with:
          script: |
            github.repos.updateBranchProtection({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'main',
              enforce_admins: true,
              required_pull_request_reviews: {
                required_approving_review_count: 1
              }
            })
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
